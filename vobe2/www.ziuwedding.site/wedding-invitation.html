<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thi·ªáp M·ªùi C∆∞·ªõi</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --cream: #faf7f2;
    --gold: #c9a96e;
    --gold-light: #e8d5a3;
    --gold-dark: #9a7a45;
    --brown: #5c4033;
    --text: #3a2a1e;
    --white: #ffffff;
  }

  body {
    font-family: 'Jost', sans-serif;
    background: var(--cream);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background: radial-gradient(ellipse at 10% 20%, rgba(201,169,110,0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(201,169,110,0.10) 0%, transparent 50%);
    pointer-events: none;
  }

  .container { width: 100%; max-width: 560px; padding: 40px 24px; position: relative; z-index: 1; }

  /* Header */
  .header { text-align: center; margin-bottom: 48px; animation: fadeDown 0.8s ease both; }
  .ornament { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px; }
  .ornament-line { width: 60px; height: 1px; background: linear-gradient(to right, transparent, var(--gold)); }
  .ornament-line.right { background: linear-gradient(to left, transparent, var(--gold)); }
  .ornament-diamond { width: 8px; height: 8px; background: var(--gold); transform: rotate(45deg); }
  .header h1 { font-family: 'Cormorant Garamond', serif; font-size: 42px; font-weight: 300; color: var(--text); line-height: 1.1; letter-spacing: 2px; }
  .header h1 em { font-style: italic; color: var(--gold-dark); }
  .header p { margin-top: 12px; font-size: 13px; font-weight: 300; letter-spacing: 3px; text-transform: uppercase; color: #999; }

  /* Card */
  .card {
    background: var(--white);
    border: 1px solid rgba(201,169,110,0.25);
    border-radius: 4px;
    padding: 40px 36px;
    box-shadow: 0 20px 60px rgba(92,64,51,0.08), 0 4px 12px rgba(201,169,110,0.1);
    animation: fadeUp 0.8s 0.2s ease both;
    position: relative; overflow: hidden;
  }
  .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(to right, var(--gold-light), var(--gold), var(--gold-light)); }
  .corner { position: absolute; width: 30px; height: 30px; }
  .corner-tl { top: 10px; left: 10px; border-top: 1.5px solid var(--gold-light); border-left: 1.5px solid var(--gold-light); }
  .corner-tr { top: 10px; right: 10px; border-top: 1.5px solid var(--gold-light); border-right: 1.5px solid var(--gold-light); }
  .corner-bl { bottom: 10px; left: 10px; border-bottom: 1.5px solid var(--gold-light); border-left: 1.5px solid var(--gold-light); }
  .corner-br { bottom: 10px; right: 10px; border-bottom: 1.5px solid var(--gold-light); border-right: 1.5px solid var(--gold-light); }

  /* Form */
  .form-label { display: block; font-size: 11px; font-weight: 500; letter-spacing: 3px; text-transform: uppercase; color: var(--gold-dark); margin-bottom: 10px; }
  .form-label.optional::after { content: ' (tu·ª≥ ch·ªçn)'; color: #ccc; font-size: 10px; letter-spacing: 1px; text-transform: none; font-weight: 300; }

  .input-row { display: flex; gap: 10px; }
  .input-row input, .desc-input {
    padding: 13px 18px;
    border: 1px solid rgba(201,169,110,0.4);
    border-radius: 2px;
    color: var(--text);
    background: var(--cream);
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .input-row input {
    flex: 1;
    font-family: 'Cormorant Garamond', serif;
    font-size: 18px; font-weight: 400;
  }
  .input-row input::placeholder { color: #c0b09a; font-style: italic; }
  .input-row input:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,169,110,0.12); }
  .desc-input:focus { border-color: var(--gold) !important; box-shadow: 0 0 0 3px rgba(201,169,110,0.12); outline: none; }

  .desc-field { margin-top: 10px; position: relative; }
  .desc-input {
    width: 100%;
    font-family: 'Jost', sans-serif;
    font-size: 12px; font-weight: 300;
    padding: 8px 12px 8px 70px !important;
    color: #999 !important;
    background: var(--cream) !important;
    border: 1px solid rgba(201,169,110,0.25) !important;
    border-radius: 2px;
  }
  .desc-input::placeholder { color: #ccc; font-style: italic; }
  .desc-field-label {
    position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
    font-size: 9px; font-weight: 500; letter-spacing: 2px; text-transform: uppercase;
    color: rgba(201,169,110,0.6); pointer-events: none; white-space: nowrap;
  }

  /* Guest preview */
  .guest-display { display: none; margin-top: 18px; }
  .guest-display.show { display: block; }
  .guest-preview {
    background: #fdfaf5;
    border: 1px dashed rgba(201,169,110,0.35);
    border-radius: 2px;
    padding: 20px 24px 18px;
    text-align: center;
    position: relative;
  }
  .guest-preview .lbl {
    display: block;
    font-size: 10px; color: #c0b0a0; letter-spacing: 3px; text-transform: uppercase;
    margin-bottom: 8px;
  }
  .guest-preview .name {
    display: block;
    font-family: 'Cormorant Garamond', serif;
    font-size: 26px; font-style: italic;
    color: var(--gold-dark); font-weight: 400;
    letter-spacing: 1px;
  }
  .guest-preview .desc-preview { display: none; }
  .note-tag {
    display: none;
    margin-top: 8px;
    font-size: 10px; color: #bbb;
    letter-spacing: 1.5px; text-transform: uppercase;
    font-style: normal;
  }

  .btn-generate {
    margin-top: 16px; width: 100%; padding: 13px;
    background: linear-gradient(135deg, var(--gold-dark), var(--gold));
    color: var(--white); border: none; border-radius: 2px;
    font-family: 'Jost', sans-serif; font-size: 11px; font-weight: 500;
    letter-spacing: 2.5px; text-transform: uppercase;
    cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn-generate:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(201,169,110,0.4); }
  .btn-generate:active { transform: translateY(0); }

  /* Result */
  .url-result { display: none; animation: fadeUp 0.4s ease both; }
  .url-result.show { display: block; }
  .url-label { margin-top: 20px; font-size: 10px; font-weight: 500; letter-spacing: 3px; text-transform: uppercase; color: #bbb; margin-bottom: 8px; }
  .url-box { display: flex; gap: 10px; align-items: center; }
  .url-input {
    flex: 1; padding: 11px 14px;
    border: 1px solid rgba(201,169,110,0.3); border-radius: 2px;
    font-family: 'Jost', sans-serif; font-size: 12px; color: #aaa;
    background: #fdfaf5; outline: none;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .btn-invite {
    padding: 11px 16px; background: var(--text); color: var(--white);
    border: none; border-radius: 2px; font-family: 'Jost', sans-serif;
    font-size: 10px; font-weight: 500; letter-spacing: 2px; text-transform: uppercase;
    cursor: pointer; transition: all 0.2s; white-space: nowrap;
    display: flex; align-items: center; gap: 7px;
  }
  .btn-invite:hover { background: var(--brown); transform: translateY(-1px); }
  .btn-invite svg { width: 13px; height: 13px; }

  /* ‚îÄ‚îÄ POPUP ‚îÄ‚îÄ */
  .overlay {
    position: fixed; inset: 0;
    background: rgba(30,20,10,0.55);
    backdrop-filter: blur(6px);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000; opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease; padding: 20px;
  }
  .overlay.show { opacity: 1; pointer-events: all; }

  .popup {
    background: var(--white); border-radius: 8px;
    width: 100%; max-width: 360px; overflow: hidden;
    transform: translateY(24px) scale(0.96);
    transition: transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 30px 70px rgba(0,0,0,0.22); position: relative;
  }
  .overlay.show .popup { transform: translateY(0) scale(1); }

  .popup-header {
    background: linear-gradient(135deg, var(--text) 0%, #7a5542 100%);
    padding: 20px 24px 16px; text-align: center; position: relative;
  }
  .popup-header::after {
    content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 60%; height: 1px;
    background: linear-gradient(to right, transparent, rgba(201,169,110,0.5), transparent);
  }
  .popup-rings { font-size: 20px; margin-bottom: 6px; }
  .popup-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 300; color: var(--white); letter-spacing: 1px; }
  .popup-header h2 em { font-style: italic; color: var(--gold-light); }
  .popup-guest { font-family: 'Cormorant Garamond', serif; font-size: 13px; font-style: italic; color: var(--gold-light); margin-top: 4px; opacity: 0.8; }
  .btn-close {
    position: absolute; top: 10px; right: 10px;
    background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.7);
    width: 26px; height: 26px; border-radius: 50%; cursor: pointer; font-size: 13px;
    display: flex; align-items: center; justify-content: center; transition: background 0.2s;
  }
  .btn-close:hover { background: rgba(255,255,255,0.2); color: white; }

  .popup-body { padding: 18px 20px 20px; }

  .share-title { font-size: 10px; font-weight: 500; letter-spacing: 3px; text-transform: uppercase; color: #bbb; margin-bottom: 14px; text-align: center; }

  /* ‚îÄ‚îÄ Compact icon row ‚îÄ‚îÄ */
  .share-list {
    display: flex;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 18px;
  }

  .shr {
    display: flex; flex-direction: column; align-items: center; gap: 5px;
    cursor: pointer; background: none; border: none; padding: 0;
    transition: transform 0.18s; width: 56px;
  }
  .shr:hover { transform: translateY(-3px); }

  .shr-circle {
    width: 44px; height: 44px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 7px rgba(0,0,0,0.15); overflow: hidden; flex-shrink: 0;
  }

  .shr-label { font-size: 9px; font-weight: 500; letter-spacing: 0.3px; text-transform: uppercase; color: #888; line-height: 1; text-align: center; }

  /* Divider */
  .divider { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
  .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: rgba(201,169,110,0.2); }
  .divider span { font-size: 9.5px; color: #ccc; letter-spacing: 2px; text-transform: uppercase; }

  .copy-row {
    display: flex; gap: 8px; background: var(--cream);
    border: 1px solid rgba(201,169,110,0.3); border-radius: 4px;
    padding: 3px 3px 3px 12px; align-items: center;
  }
  .copy-row span { flex: 1; font-size: 11.5px; color: #999; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .btn-copy-small {
    padding: 8px 13px; background: var(--gold); color: white; border: none;
    border-radius: 3px; font-size: 10px; font-weight: 500;
    letter-spacing: 1px; text-transform: uppercase;
    cursor: pointer; transition: background 0.2s; white-space: nowrap;
  }
  .btn-copy-small:hover { background: var(--gold-dark); }
  .btn-copy-small.copied { background: #4caf50; }

  @keyframes fadeDown { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
  @keyframes fadeUp   { from { opacity:0; transform:translateY(16px);  } to { opacity:1; transform:translateY(0); } }

  @media (max-width: 480px) {
    .card { padding: 28px 18px; }
    .header h1 { font-size: 34px; }
    .url-box { flex-direction: column; }
    .url-input, .btn-invite { width: 100%; justify-content: center; }
    .shr { width: 48px; }
    .shr-circle { width: 40px; height: 40px; }
    .share-list { gap: 6px; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="ornament">
      <div class="ornament-line"></div>
      <div class="ornament-diamond"></div>
      <div class="ornament-line right"></div>
    </div>
    <h1>T·∫°o <em>Thi·ªáp</em><br>M·ªùi C∆∞·ªõi</h1>
    <p>G·ª≠i l·ªùi m·ªùi ƒë·∫øn kh√°ch qu√Ω</p>
  </div>

  <div class="card">
    <div class="corner corner-tl"></div>
    <div class="corner corner-tr"></div>
    <div class="corner corner-bl"></div>
    <div class="corner corner-br"></div>

    <label class="form-label">T√™n kh√°ch m·ªùi</label>
    <div class="input-row">
      <input type="text" id="guestName" placeholder="Nh·∫≠p t√™n kh√°ch m·ªùi‚Ä¶" />
    </div>

    <div class="desc-field">
      <span class="desc-field-label">Ghi ch√∫</span>
      <input type="text" id="guestDesc" class="desc-input" placeholder="b·∫°n th√¢n, ƒë·ªìng nghi·ªáp, h·ªç h√†ng‚Ä¶" />
    </div>

    <button class="btn-generate" onclick="generateLink()">T·∫°o ƒë∆∞·ªùng d·∫´n</button>

    <div class="guest-display" id="guestDisplay">
      <div class="guest-preview">
        <span class="lbl">K√≠nh g·ª≠i</span>
        <span class="name" id="guestNameDisplay"></span>
        <span class="note-tag" id="guestDescDisplay"></span>
      </div>
    </div>

    <div class="url-result" id="urlResult">
      <div class="url-label">ƒê∆∞·ªùng d·∫´n thi·ªáp m·ªùi</div>
      <div class="url-box">
        <input type="text" class="url-input" id="generatedUrl" readonly />
        <button class="btn-invite" onclick="openSharePopup()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
          </svg>
          M·ªùi c∆∞·ªõi
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Share Popup -->
<div class="overlay" id="overlay" onclick="closeOnOverlay(event)">
  <div class="popup">
    <div class="popup-header">
      <button class="btn-close" onclick="closePopup()">‚úï</button>
      <div class="popup-rings">üíç</div>
      <h2>Chia s·∫ª <em>Thi·ªáp</em> C∆∞·ªõi</h2>
      <div class="popup-guest" id="popupGuestName"></div>
    </div>

    <div class="popup-body">
      <p class="share-title">Chia s·∫ª qua</p>

      <div class="share-list">

        <button class="shr" onclick="shareZalo()" title="Zalo">
          <div class="shr-circle" style="background:#0068ff;">
            <svg width="26" height="26" viewBox="0 0 48 48">
              <text x="24" y="33" text-anchor="middle" font-size="24" font-weight="bold" fill="white" font-family="Arial">Z</text>
            </svg>
          </div>
          <span class="shr-label">Zalo</span>
        </button>

        <button class="shr" onclick="shareZaloMsg()" title="Zalo Chat">
          <div class="shr-circle" style="background:#0052cc;">
            <svg width="44" height="44" viewBox="0 0 44 44">
              <text x="16" y="24" font-size="16" font-weight="bold" fill="white" font-family="Arial">Z</text>
              <circle cx="30" cy="30" r="9" fill="#00c853"/>
              <text x="30" y="35" text-anchor="middle" font-size="13" fill="white" font-family="Arial">+</text>
            </svg>
          </div>
          <span class="shr-label">Zalo Chat</span>
        </button>

        <button class="shr" onclick="shareFacebook()" title="Facebook">
          <div class="shr-circle" style="background:#1877f2;">
            <svg width="24" height="24" viewBox="0 0 48 48">
              <path d="M28 16h-3c-1.1 0-1 .9-1 1.5V20h4l-.5 4H24v12h-4V24h-3v-4h3v-3c0-3.3 2-5 5-5 1.4 0 3 .1 3 .1V16z" fill="white"/>
            </svg>
          </div>
          <span class="shr-label">Facebook</span>
        </button>

        <button class="shr" onclick="shareMessenger()" title="Messenger">
          <div class="shr-circle">
            <svg width="44" height="44" viewBox="0 0 44 44">
              <defs><linearGradient id="mg" x1="0" y1="0" x2="44" y2="44"><stop offset="0%" stop-color="#0099ff"/><stop offset="100%" stop-color="#a033ff"/></linearGradient></defs>
              <circle cx="22" cy="22" r="22" fill="url(#mg)"/>
              <path d="M22 7C13.163 7 6 13.71 6 21.95c0 4.594 2.187 8.706 5.623 11.473V37l5.096-2.804c1.358.378 2.797.58 4.281.58 8.837 0 16-6.71 16-14.95C37 13.71 30.837 7 22 7zm1.616 20.137l-4.07-4.346-7.952 4.346 8.741-9.275 4.17 4.347 7.853-4.347-8.742 9.275z" fill="white"/>
            </svg>
          </div>
          <span class="shr-label">Messenger</span>
        </button>

        <button class="shr" onclick="shareInstagram()" title="Instagram">
          <div class="shr-circle">
            <svg width="44" height="44" viewBox="0 0 44 44">
              <defs><linearGradient id="ig" x1="0" y1="44" x2="44" y2="0"><stop offset="0%" stop-color="#f09433"/><stop offset="40%" stop-color="#dc2743"/><stop offset="100%" stop-color="#bc1888"/></linearGradient></defs>
              <circle cx="22" cy="22" r="22" fill="url(#ig)"/>
              <rect x="11" y="11" width="22" height="22" rx="6" fill="none" stroke="white" stroke-width="1.8"/>
              <circle cx="22" cy="22" r="5.5" fill="none" stroke="white" stroke-width="1.8"/>
              <circle cx="28.5" cy="15.5" r="1.4" fill="white"/>
            </svg>
          </div>
          <span class="shr-label">Instagram</span>
        </button>

        <button class="shr" onclick="shareTikTok()" title="TikTok">
          <div class="shr-circle" style="background:#010101;">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="white">
              <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1V9.01a6.27 6.27 0 00-.79-.05 6.34 6.34 0 00-6.34 6.34 6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.33-6.34V8.69a8.18 8.18 0 004.78 1.53V6.79a4.85 4.85 0 01-1.01-.1z"/>
            </svg>
          </div>
          <span class="shr-label">TikTok</span>
        </button>

        <button class="shr" onclick="shareGmail()" title="Gmail">
          <div class="shr-circle" style="background:white; box-shadow:0 2px 8px rgba(0,0,0,0.18);">
            <svg width="24" height="18" viewBox="0 0 24 18">
              <rect width="24" height="18" rx="2" fill="#fafafa" stroke="#e0e0e0" stroke-width="0.8"/>
              <path d="M0 2l12 8 12-8" fill="none" stroke="#ea4335" stroke-width="1.8"/>
            </svg>
          </div>
          <span class="shr-label">Gmail</span>
        </button>

      </div>

      <div class="divider"><span>Link thi·ªáp</span></div>

      <div class="copy-row">
        <span id="popupUrl"></span>
        <button class="btn-copy-small" id="copyBtn" onclick="copyLinkDirect()">Copy</button>
      </div>
    </div>
  </div>
</div>

<!-- Email Input Popup -->
<div class="overlay" id="emailOverlay" onclick="closeEmailPopup(event)">
  <div class="popup" style="max-width: 420px;">
    <div class="popup-header">
      <button class="btn-close" onclick="closeEmailPopup()">‚úï</button>
      <div class="popup-rings">üìß</div>
      <h2>G·ª≠i <em>Email</em> M·ªùi C∆∞·ªõi</h2>
      <div class="popup-guest" id="emailPopupGuestName"></div>
    </div>

    <div class="popup-body">
      <p class="share-title">Nh·∫≠p email ng∆∞·ªùi nh·∫≠n</p>
      
      <div style="margin-bottom: 16px;">
        <input type="email" id="recipientEmail" placeholder="example@gmail.com" 
               style="width: 100%; padding: 12px 16px; border: 1px solid rgba(201,169,110,0.4); border-radius: 4px; 
                      font-size: 14px; font-family: 'Jost', sans-serif; outline: none; transition: border-color 0.3s;"
               onfocus="this.style.borderColor='#c9a96e'; this.style.boxShadow='0 0 0 3px rgba(201,169,110,0.12)'"
               onblur="this.style.borderColor='rgba(201,169,110,0.4)'; this.style.boxShadow='none'">
      </div>

      <button onclick="sendEmailInvitation()" 
              style="width: 100%; padding: 14px; background: linear-gradient(135deg, #8a6830, #c9a96e); 
                     color: white; border: none; border-radius: 4px; font-size: 11px; font-weight: 500; 
                     letter-spacing: 2.5px; text-transform: uppercase; cursor: pointer; font-family: 'Jost', sans-serif;
                     transition: all 0.2s;"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(201,169,110,0.4)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
        G·ª≠i Email
      </button>

      <p style="margin-top: 14px; text-align: center; font-size: 10px; color: #bbb; line-height: 1.6;">
        Email s·∫Ω ƒë∆∞·ª£c g·ª≠i v·ªõi template thi·ªáp m·ªùi HTML ƒë·∫ßy ƒë·ªß
      </p>
    </div>
  </div>
</div>

<script>
  let currentUrl = '';
  let currentGuest = '';
  
  const API_BASE = window.location.origin;
  async function generateLink() {
    const name = document.getElementById('guestName').value.trim();
    if (!name) {
      const inp = document.getElementById('guestName');
      inp.focus();
      inp.style.borderColor = '#e57373';
      inp.style.boxShadow = '0 0 0 3px rgba(229,115,115,0.15)';
      setTimeout(() => { inp.style.borderColor = ''; inp.style.boxShadow = ''; }, 2000);
      return;
    }

    const desc = document.getElementById('guestDesc').value.trim();
    
    // Disable button while creating
    const btn = document.querySelector('.btn-generate');
    const originalText = btn.textContent;
    btn.textContent = 'ƒêang t·∫°o...';
    btn.disabled = true;
    btn.style.opacity = '0.6';
    btn.style.cursor = 'not-allowed';

    try {
      // Call API to create guest and get private URL
      console.log('ƒêang g·ª≠i request t·∫°o guest:', { name, description: desc || null });
      
      const response = await fetch( `${API_BASE}/api/guests`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: name,
          description: desc || null
        })
      });

      console.log('Response status:', response.status, response.statusText);

      if (!response.ok) {
        const error = await response.json().catch(() => ({ message: 'Kh√¥ng th·ªÉ t·∫°o thi·ªáp m·ªùi' }));
        console.error('API error:', error);
        throw new Error(error.message || 'Kh√¥ng th·ªÉ t·∫°o thi·ªáp m·ªùi');
      }

      const data = await response.json();
      console.log('Response data:', data);
      
      // data contains: guest, private_invitation with absolute_url
      if (!data.private_invitation || !data.private_invitation.absolute_url) {
        console.error('Invalid response format:', data);
        throw new Error('D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
      }
      
      currentGuest = name;
      currentUrl = data.private_invitation.absolute_url;

      document.getElementById('generatedUrl').value = currentUrl;
      document.getElementById('guestNameDisplay').textContent = name;

      const descEl = document.getElementById('guestDescDisplay');
      if (desc) { descEl.textContent = desc; descEl.style.display = 'block'; }
      else { descEl.textContent = ''; descEl.style.display = 'none'; }

      document.getElementById('urlResult').classList.add('show');
      document.getElementById('guestDisplay').classList.add('show');

      showToast('‚úì ƒê√£ t·∫°o thi·ªáp m·ªùi th√†nh c√¥ng!');
    } catch (error) {
      console.error('L·ªói khi t·∫°o thi·ªáp:', error);
      showToast('‚ùå ' + (error.message || 'Kh√¥ng th·ªÉ t·∫°o thi·ªáp m·ªùi. Vui l√≤ng th·ª≠ l·∫°i.'));
    } finally {
      // Re-enable button
      btn.textContent = originalText;
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
    }
  }

  function openSharePopup() {
    document.getElementById('popupGuestName').textContent = '‚Äî ' + currentGuest + ' ‚Äî';
    document.getElementById('popupUrl').textContent = currentUrl;
    document.getElementById('overlay').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closePopup() {
    document.getElementById('overlay').classList.remove('show');
    document.body.style.overflow = '';
  }

  function closeOnOverlay(e) {
    if (e.target === document.getElementById('overlay')) closePopup();
  }

  function getMsg() { return `üíç K√≠nh m·ªùi ${currentGuest} ƒë·∫øn d·ª± l·ªÖ c∆∞·ªõi c·ªßa ch√∫ng m√¨nh!\n\nXem thi·ªáp t·∫°i: ${currentUrl}`; }

  function shareZalo() { window.open(`https://zalo.me/share?text=${encodeURIComponent(getMsg())}`, '_blank'); }
  function shareZaloMsg() { window.open(`https://zalo.me/?src=qr&text=${encodeURIComponent(getMsg())}`, '_blank'); }
  function shareFacebook() { window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl)}`, '_blank'); }
  function shareMessenger() { window.open(`https://www.facebook.com/dialog/send?link=${encodeURIComponent(currentUrl)}&app_id=291494419107518&redirect_uri=${encodeURIComponent(currentUrl)}`, '_blank'); }

  function shareInstagram() {
    copyText(currentUrl);
    showToast('ƒê√£ copy link! M·ªü Instagram v√† d√°n v√†o Story ho·∫∑c Bio nh√© üì∏');
    setTimeout(() => window.open('https://www.instagram.com/', '_blank'), 800);
  }
  function shareTikTok() {
    copyText(currentUrl);
    showToast('ƒê√£ copy link! M·ªü TikTok v√† d√°n v√†o bio ho·∫∑c video nh√© üéµ');
    setTimeout(() => window.open('https://www.tiktok.com/', '_blank'), 800);
  }
  async function shareGmail() {
    // Show email input popup
    document.getElementById('emailPopupGuestName').textContent = '‚Äî ' + currentGuest + ' ‚Äî';
    document.getElementById('emailOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Focus on email input
    setTimeout(() => document.getElementById('recipientEmail').focus(), 100);
  }

  function closeEmailPopup(e) {
    if (e && e.target !== document.getElementById('emailOverlay')) return;
    document.getElementById('emailOverlay').classList.remove('show');
    document.body.style.overflow = '';
  }

  async function sendEmailInvitation() {
    const email = document.getElementById('recipientEmail').value.trim();
    
    if (!email) {
      showToast('‚ùå Vui l√≤ng nh·∫≠p email');
      document.getElementById('recipientEmail').focus();
      return;
    }

    // Simple email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showToast('‚ùå Email kh√¥ng h·ª£p l·ªá');
      return;
    }

    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'ƒêang g·ª≠i...';
    btn.disabled = true;
    btn.style.opacity = '0.6';
    btn.style.cursor = 'not-allowed';

    try {
      console.log('G·ª≠i email m·ªùi t·ªõi:', email);
      
      const response = await fetch(`${API_BASE}/api/send-invitation-email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          recipient_email: email,
          guest_name: currentGuest,
          invitation_url: currentUrl
        })
      });

      console.log('Response status:', response.status);

      if (!response.ok) {
        const error = await response.json().catch(() => ({ message: 'Kh√¥ng th·ªÉ g·ª≠i email' }));
        console.error('Email error:', error);
        throw new Error(error.message || 'Kh√¥ng th·ªÉ g·ª≠i email');
      }

      const data = await response.json();
      console.log('Email sent successfully:', data);
      
      showToast('‚úì Email ƒë√£ g·ª≠i th√†nh c√¥ng!');
      document.getElementById('recipientEmail').value = '';
      closeEmailPopup();
    } catch (error) {
      console.error('L·ªói g·ª≠i email:', error);
      showToast('‚ùå ' + (error.message || 'Kh√¥ng th·ªÉ g·ª≠i email. Vui l√≤ng th·ª≠ l·∫°i.'));
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
    }
  }

  function copyText(text) {
    return new Promise((resolve, reject) => {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text)
          .then(resolve)
          .catch(() => {
            try {
              fallbackCopy(text);
              resolve();
            } catch (err) {
              reject(err);
            }
          });
      } else {
        try {
          fallbackCopy(text);
          resolve();
        } catch (err) {
          reject(err);
        }
      }
    });
  }
  function fallbackCopy(text) {
    const el = document.createElement('textarea');
    el.value = text; document.body.appendChild(el); el.select();
    document.execCommand('copy'); document.body.removeChild(el);
  }
  function copyLinkDirect() {
    copyText(currentUrl);
    const btn = document.getElementById('copyBtn');
    btn.textContent = 'ƒê√£ copy ‚úì'; btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2200);
  }

  function showToast(msg) {
    let t = document.getElementById('_toast');
    if (!t) {
      t = document.createElement('div'); t.id = '_toast';
      t.style.cssText = 'position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(20px);background:#3a2a1e;color:#fff;padding:11px 20px;border-radius:30px;font-size:12.5px;font-family:Jost,sans-serif;z-index:9999;opacity:0;transition:all .3s;max-width:300px;text-align:center;line-height:1.4;box-shadow:0 4px 20px rgba(0,0,0,.25);';
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity = '1'; t.style.transform = 'translateX(-50%) translateY(0)';
    clearTimeout(t._timer);
    t._timer = setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(-50%) translateY(20px)'; }, 3000);
  }

  document.getElementById('guestName').addEventListener('keydown', e => { if (e.key === 'Enter') generateLink(); });
</script>
<script src="https://thiepcuoi.me/floating-widget.js" defer></script>
</body>
</html>