<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phương Nam & Thu Bích</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Jost:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --cream: #faf7f2; --cream2: #f3ede2;
  --gold: #c9a96e; --gold-light: #e8d5a3; --gold-dark: #9a7a45;
  --text: #3a2a1e; --text-muted: #a0907a;
  --white: #ffffff; --border: rgba(201,169,110,0.22);
}
body { font-family:'Jost',sans-serif; background:var(--cream); color:var(--text); min-height:100vh; overflow-x:hidden; }
body::before { content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
  background: radial-gradient(ellipse at 15% 10%, rgba(201,169,110,0.11) 0%, transparent 55%),
              radial-gradient(ellipse at 85% 90%, rgba(201,169,110,0.08) 0%, transparent 50%); }

.topbar { background:var(--text); padding:0 28px; display:flex; align-items:center; height:52px; position:sticky; top:0; z-index:100; box-shadow:0 2px 20px rgba(0,0,0,0.15); }
.topbar-brand { font-family:'Cormorant Garamond',serif; font-size:17px; font-style:italic; color:var(--gold-light); letter-spacing:1px; }
.topbar-brand span { color:rgba(255,255,255,0.3); font-style:normal; margin:0 7px; }

.page { max-width:860px; margin:0 auto; padding:28px 20px 56px; position:relative; z-index:1; display:flex; flex-direction:column; gap:18px; }

/* HERO */
.hero { text-align:center; padding:10px 0 0; animation:fadeDown 0.7s ease both; }
.ornament { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:10px; }
.ol { width:44px; height:1px; background:linear-gradient(to right, transparent, var(--gold)); }
.ol.r { background:linear-gradient(to left, transparent, var(--gold)); }
.od { width:6px; height:6px; background:var(--gold); transform:rotate(45deg); }
.hero-names { font-family:'Cormorant Garamond',serif; font-size:clamp(22px,4vw,34px); font-weight:300; color:var(--text); letter-spacing:2px; }
.hero-names em { font-style:italic; color:var(--gold-dark); }
.hero-sub { font-size:10px; font-weight:300; letter-spacing:3.5px; text-transform:uppercase; color:#c0b09a; margin-top:5px; }
/* COUNTDOWN */
.countdown-wrap {
  margin-top: 14px;
  display: flex; align-items: flex-end; justify-content: center; gap: 0;
}
.cd-block {
  display: flex; flex-direction: column; align-items: center;
  position: relative; padding: 0 clamp(8px,2.5vw,20px);
}
.cd-sep {
  font-family: 'Cormorant Garamond', serif;
  font-size: clamp(30px, 6.5vw, 48px);
  font-weight: 300; font-style: italic;
  color: var(--gold); opacity: 0.35;
  line-height: 1; padding-bottom: 19px;
  align-self: flex-end;
  user-select: none;
}
.cd-num {
  font-family: 'Cormorant Garamond', serif;
  font-size: clamp(30px, 6.5vw, 48px);
  font-weight: 300; font-style: italic;
  line-height: 1; letter-spacing: 1px;
  color: var(--gold-dark);
  text-shadow:
    0 0 20px rgba(201,169,110,0.55),
    0 0 40px rgba(201,169,110,0.25),
    0 1px 0 rgba(255,255,255,0.4);
  animation: glow 2.4s ease-in-out infinite alternate;
  min-width: 2ch; text-align: center;
}
.cd-label {
  font-family: 'Jost', sans-serif;
  font-size: 8px; font-weight: 500; letter-spacing: 2.5px; text-transform: uppercase;
  color: #c5b090; margin-top: 5px;
}
@keyframes glow {
  from { text-shadow: 0 0 12px rgba(201,169,110,0.3), 0 0 24px rgba(201,169,110,0.1); color: var(--gold-dark); }
  to   { text-shadow: 0 0 22px rgba(201,169,110,0.7), 0 0 44px rgba(201,169,110,0.3), 0 0 60px rgba(201,169,110,0.1); color: #b8893a; }
}
.cd-block:nth-child(2) .cd-num { animation-delay: 0.5s; }
.cd-block:nth-child(3) .cd-num { animation-delay: 1s; }
.cd-block:nth-child(4) .cd-num { animation-delay: 1.5s; }

/* THIEP */
.thiep-card { background:var(--text); border-radius:3px; overflow:hidden; position:relative; box-shadow:0 8px 32px rgba(58,42,30,0.2); animation:fadeUp 0.55s 0.1s ease both; }
.thiep-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:linear-gradient(to right,var(--gold-dark),var(--gold-light),var(--gold),var(--gold-light),var(--gold-dark)); }
.thiep-inner { display:flex; align-items:center; gap:16px; padding:15px 20px 15px 22px; }
.thiep-text { flex:1; min-width:0; }
.thiep-label { font-size:9px; font-weight:600; letter-spacing:3px; text-transform:uppercase; color:rgba(201,169,110,0.5); margin-bottom:4px; }
.thiep-title { font-family:'Cormorant Garamond',serif; font-size:clamp(14px,2.5vw,19px); font-style:italic; color:var(--gold-light); letter-spacing:1px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.thiep-url { margin-top:3px; font-size:9px; color:rgba(255,255,255,0.2); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.thiep-actions { display:flex; gap:7px; flex-shrink:0; }
.btn-t { display:inline-flex; align-items:center; gap:5px; padding:8px 14px; border-radius:2px; cursor:pointer; font-family:'Jost',sans-serif; font-size:9.5px; font-weight:600; letter-spacing:1.5px; text-transform:uppercase; transition:all 0.2s; white-space:nowrap; border:none; text-decoration:none; }
.btn-t svg { width:10px; height:10px; }
.btn-t-copy { background:rgba(201,169,110,0.12); color:var(--gold-light); border:1px solid rgba(201,169,110,0.26); }
.btn-t-copy:hover { background:rgba(201,169,110,0.22); }
.btn-t-copy.copied { background:rgba(90,138,106,0.2); color:#a8d4b8; border-color:rgba(90,138,106,0.35); }
.btn-t-view { background:linear-gradient(135deg,var(--gold-dark),var(--gold)); color:white; }
.btn-t-view:hover { filter:brightness(1.1); transform:translateY(-1px); }

/* STATS */
.stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; animation:fadeUp 0.55s 0.18s ease both; }
.stat { background:var(--white); border:1px solid var(--border); border-radius:3px; padding:12px 14px; text-align:center; position:relative; overflow:hidden; }
.stat::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(to right,transparent,var(--gold),transparent); }
.stat-val { font-family:'Cormorant Garamond',serif; font-size:28px; color:var(--text); line-height:1; }
.stat-label { font-size:8px; letter-spacing:2px; text-transform:uppercase; color:var(--text-muted); margin-top:4px; }

/* NAV */
.nav-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; animation:fadeUp 0.55s 0.25s ease both; }
.nav-card { background:var(--white); border:1px solid var(--border); border-radius:3px; padding:12px 14px; cursor:pointer; text-decoration:none; display:flex; align-items:center; gap:11px; position:relative; overflow:hidden; transition:transform 0.18s,box-shadow 0.18s,border-color 0.18s; }
.nav-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(to right,var(--gold-light),var(--gold)); opacity:0; transition:opacity 0.2s; }
.nav-card:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(92,64,51,0.09); border-color:rgba(201,169,110,0.4); }
.nav-card:hover::before { opacity:1; }
.nav-ico { width:30px; height:30px; background:var(--cream2); border:1px solid var(--border); border-radius:2px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.nav-ico svg { width:13px; height:13px; color:var(--gold-dark); }
.nav-lbl { font-size:8px; font-weight:600; letter-spacing:2px; text-transform:uppercase; color:var(--text-muted); }
.nav-ttl { font-family:'Cormorant Garamond',serif; font-size:14px; font-style:italic; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.nav-arr { margin-left:auto; font-size:12px; color:rgba(201,169,110,0.3); flex-shrink:0; transition:transform 0.2s,color 0.2s; }
.nav-card:hover .nav-arr { transform:translateX(3px); color:var(--gold); }

#_toast { position:fixed; bottom:22px; left:50%; transform:translateX(-50%) translateY(14px); background:var(--text); color:#fff; padding:10px 18px; border-radius:30px; font-size:12px; z-index:9999; opacity:0; transition:all .25s; pointer-events:none; box-shadow:0 4px 18px rgba(0,0,0,.22); }
#_toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

@keyframes fadeDown { from{opacity:0;transform:translateY(-12px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeUp   { from{opacity:0;transform:translateY(10px)}  to{opacity:1;transform:translateY(0)} }

@media(max-width:600px){
  .page{padding:16px 14px 44px;gap:12px;}
  .topbar{padding:0 16px;}
  .thiep-inner{flex-direction:column;align-items:flex-start;gap:10px;padding:13px 15px;}
  .thiep-actions{width:100%;}
  .btn-t{flex:1;justify-content:center;}
  .thiep-url{display:none;}
  .nav-grid{grid-template-columns:1fr;gap:7px;}
}
</style>
</head>
<body>
<div id="_toast"></div>

<div class="page">

  <div class="hero">
    <div class="ornament"><div class="ol"></div><div class="od"></div><div class="ol r"></div></div>
    <div class="hero-names">Phương Nam <em>&amp; Thu Bích</em></div>
    <div class="hero-sub" id="weddingDateLabel">Quản lý thiệp cưới</div>
    <div class="countdown-wrap">
      <div class="cd-block">
        <div class="cd-num" id="cdDays">—</div>
        <div class="cd-label">Ngày</div>
      </div>
      <span class="cd-sep">:</span>
      <div class="cd-block">
        <div class="cd-num" id="cdHours">—</div>
        <div class="cd-label">Giờ</div>
      </div>
      <span class="cd-sep">:</span>
      <div class="cd-block">
        <div class="cd-num" id="cdMins">—</div>
        <div class="cd-label">Phút</div>
      </div>
      <span class="cd-sep">:</span>
      <div class="cd-block">
        <div class="cd-num" id="cdSecs">—</div>
        <div class="cd-label">Giây</div>
      </div>
    </div>
  </div>

  <div class="thiep-card">
    <div class="thiep-inner">
      <div class="thiep-text">
        <div class="thiep-label">Thiệp mời chung</div>
        <div class="thiep-title">Phương Nam &amp; Thu Bích</div>
        <div class="thiep-url" id="thiepUrlText">—</div>
      </div>
      <div class="thiep-actions">
        <button class="btn-t btn-t-copy" id="btnCopy" onclick="copyThiep()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          Copy Link
        </button>
        <a class="btn-t btn-t-view" id="thiepViewLink" href="#" target="_blank">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          Xem thiệp
        </a>
      </div>
    </div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-val" id="qsGuests">12</div><div class="stat-label">Khách đã tạo</div></div>
    <div class="stat"><div class="stat-val" id="qsRsvp">8</div><div class="stat-label">Xác nhận đến</div></div>
  </div>

  <div class="nav-grid">
    <a class="nav-card" href="/moi-cuoi">
      <div class="nav-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 5v14M5 12h14"/></svg></div>
      <div style="min-width:0;flex:1;"><div class="nav-lbl">Tạo thiệp </div><div class="nav-ttl">Tạo thiệp theo tên riêng</div></div>
      <div class="nav-arr">→</div>
    </a>
    <a class="nav-card" href="/danh-sach">
      <div class="nav-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/></svg></div>
      <div style="min-width:0;flex:1;"><div class="nav-lbl">Thiệp mời riêng</div><div class="nav-ttl">Danh sách thiệp mời đã tạo theo tên riêng</div></div>
      <div class="nav-arr">→</div>
    </a>
    <a class="nav-card" href="/xac-nhan">
      <div class="nav-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
      <div style="min-width:0;flex:1;"><div class="nav-lbl">Xác nhận tham dự </div><div class="nav-ttl">Xác nhận tham dự tiệc cưới và chúc phúc</div></div>
      <div class="nav-arr">→</div>
    </a>
  </div>

</div>
<script>
const API_BASE = window.location.origin;
const YES_KEYS = ['mình sẽ tham dự','sẽ tham dự','tham dự','có thể đến','đi','có'];
let thiepUrl = '';
let weddingDate = '';

function parseWeddingDate(value) {
  if (!value) return null;
  const dateStr = String(value).trim();
  
  // Handle YYYY-MM-DD or YYYY-MM-DD HH:MM:SS format
  if (dateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
    const parts = dateStr.split(' ');
    const datePart = parts[0]; // YYYY-MM-DD
    const timePart = parts[1] || '00:00:00'; // HH:MM:SS (default midnight)
    
    const [year, month, day] = datePart.split('-').map(Number);
    const [hour, min, sec] = timePart.split(':').map(Number);
    
    // Create date in local timezone
    return new Date(year, month - 1, day, hour || 0, min || 0, sec || 0);
  }
  
  // Fallback for other formats
  const d = new Date(dateStr);
  return isNaN(d.getTime()) ? null : d;
}

function formatWeddingDate(value) {
  const d = parseWeddingDate(value);
  if (!d) return '';
  return d.toLocaleDateString('vi-VN');
}

function updateCountdown(targetDate) {
  if (!targetDate) {
    ['cdDays','cdHours','cdMins','cdSecs'].forEach(id => document.getElementById(id).textContent = '00');
    return;
  }
  const now = new Date();
  const diff = targetDate - now;
  if (diff <= 0) {
    ['cdDays','cdHours','cdMins','cdSecs'].forEach(id => document.getElementById(id).textContent = '00');
    return;
  }
  const d = Math.floor(diff / 86400000);
  const h = Math.floor((diff % 86400000) / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  const s = Math.floor((diff % 60000) / 1000);
  document.getElementById('cdDays').textContent  = String(d).padStart(2,'0');
  document.getElementById('cdHours').textContent = String(h).padStart(2,'0');
  document.getElementById('cdMins').textContent  = String(m).padStart(2,'0');
  document.getElementById('cdSecs').textContent  = String(s).padStart(2,'0');
}

function applyPublicConfig(cfg) {
  thiepUrl = cfg.thiep_public_url || '';
  weddingDate = cfg.ngay_cuoi || '';

  const urlText = document.getElementById('thiepUrlText');
  const viewLink = document.getElementById('thiepViewLink');
  const dateLabel = document.getElementById('weddingDateLabel');
  const dateStr = formatWeddingDate(weddingDate);

  urlText.textContent = thiepUrl || '—';
  viewLink.href = thiepUrl || '#';
  if (dateStr) {
    dateLabel.textContent = `Quản lý thiệp cưới · ${dateStr}`;
  }

  const targetDate = parseWeddingDate(weddingDate);
  updateCountdown(targetDate);
  if (targetDate) {
    setInterval(() => updateCountdown(targetDate), 1000);
  }
}

async function loadStats() {
  try {
    const res = await fetch(`${API_BASE}/api/guests`);
    const data = await res.json();
    if (Array.isArray(data)) document.getElementById('qsGuests').textContent = data.length;
  } catch (e) {}

  try {
    const res = await fetch(`${API_BASE}/api/messages-checkins`);
    const rawData = await res.json();
    if (Array.isArray(rawData)) {
      const seen = new Set();
      const uniqueData = rawData.filter(item => {
        const key = `${item.id}-${item.name_guest}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
      const count = uniqueData.filter(item => YES_KEYS.some(key => (item.confirm_attendance || '').toLowerCase().includes(key))).length;
      document.getElementById('qsRsvp').textContent = count;
    }
  } catch (e) {}
}

async function loadPublicConfig() {
  try {
    const res = await fetch(`${API_BASE}/api/public-config`);
    if (!res.ok) throw new Error('Failed to load public config');
    const cfg = await res.json();
    applyPublicConfig(cfg || {});
  } catch (e) {
    applyPublicConfig({});
  }
}

function copyThiep() {
  const textToCopy = thiepUrl || '';
  if (!textToCopy) {
    toast('Chưa có link thiệp');
    return;
  }
  navigator.clipboard.writeText(textToCopy).then(() => {
    const b = document.getElementById('btnCopy');
    b.classList.add('copied');
    b.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:10px;height:10px"><polyline points="20 6 9 17 4 12"/></svg> Đã copy!';
    toast('Đã copy link thiệp ✓');
    setTimeout(() => {
      b.classList.remove('copied');
      b.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:10px;height:10px"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> Copy Link';
    }, 2500);
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = textToCopy; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    toast('Đã copy ✓');
  });
}

function toast(m) {
  const t = document.getElementById('_toast');
  t.textContent = m; t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('show'), 2600);
}

loadPublicConfig();
loadStats();
</script>
</body>
</html>